<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>MBU Smart Transport - Admin SOS Alerts</title>
    <!-- Reuse existing stylesheet from the project (expects styles.css in same folder) -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* small admin-specific tweaks while keeping the main theme */
        .admin-section {
            margin-top: 10px;
        }
        .alerts-table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255,255,255,0.95);
            color: #222;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 8px 18px rgba(0,0,0,0.12);
        }
        .alerts-table th, .alerts-table td {
            padding: 12px 14px;
            text-align: left;
            border-bottom: 1px solid rgba(0,0,0,0.06);
            font-size: 0.95rem;
        }
        .alerts-table th {
            background: linear-gradient(90deg, rgba(102,126,234,0.12), rgba(118,75,162,0.12));
            color: #111;
            font-weight: 700;
        }
        .tag-urgent {
            background: linear-gradient(90deg,#ff7a7a,#ffb199);
            color: white;
            padding: 6px 8px;
            border-radius: 999px;
            font-weight: 700;
            font-size: 0.8rem;
            display: inline-block;
        }
        .small-muted {
            font-size: 0.85rem;
            color: #555;
        }
        .controls {
            display:flex;
            gap:12px;
            align-items:center;
            margin-bottom:12px;
        }
        .controls input, .controls select {
            padding:8px 10px;
            border-radius:8px;
            border:1px solid rgba(0,0,0,0.08);
            background: white;
        }
        .controls button {
            padding:10px 14px;
            border-radius:8px;
            border:none;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color:white;
            cursor:pointer;
            font-weight:700;
        }
        @media (max-width: 900px) {
            .alerts-table th, .alerts-table td { font-size:0.85rem; padding:10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöó MBU Smart Transport</h1>
            <p>Intelligent Auto Booking & Dynamic Pricing System</p>
            <div class="mode-switcher">
                <button class="mode-btn" onclick="switchMode('student')">üë®‚Äçüéì Student</button>
                <button class="mode-btn" onclick="switchMode('driver')">üöô Driver</button>
                <button class="mode-btn active" onclick="switchMode('admin')">‚öô Admin</button>
            </div>
        </div>

        <div class="main-layout" style="margin-top:18px;">
            <!-- Admin Panel (focus) -->
            <div class="card" id="adminPanel">
                <h2>‚öô System Admin</h2>

                <div class="admin-section">
                    <h3>üÜò Emergency SOS alerts Triggered</h3>
                    <p class="small-muted">View real-time emergency triggers reported by students/drivers. Click an alert to view details or acknowledge.</p>

                    <div class="controls" style="margin-top:8px;">
                        <select id="filterLocation">
                            <option value="">Filter: All locations</option>
                            <option>MBU Main Gate</option>
                            <option>MBU Hostels</option>
                            <option>Library Block</option>
                            <option>Tirupati Main</option>
                        </select>

                        <select id="filterStatus">
                            <option value="">Status: All</option>
                            <option value="new">New</option>
                            <option value="ack">Acknowledged</option>
                            <option value="resolved">Resolved</option>
                        </select>

                        <button onclick="clearFilters()">Clear</button>

                        <div style="flex:1"></div>

                        <!-- a quick simulator (for admin/dev testing) -->
                        <button onclick="simulateSOS()">Simulate SOS</button>
                    </div>

                    <div style="overflow:auto; margin-top:10px;">
                        <table class="alerts-table" id="emergencyTable" role="table" aria-label="Emergency SOS alerts">
                            <thead>
                                <tr>
                                    <th style="width:160px">Timestamp</th>
                                    <th>Student Name</th>
                                    <th>Student Phone</th>
                                    <th>Driver Name</th>
                                    <th>Driver Phone</th>
                                    <th>Emergency Contact</th>
                                    <th>Location</th>
                                    <th style="width:120px">Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- rows populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>

                    <p id="noAlertsMsg" class="small-muted" style="display:none; margin-top:10px;">No emergency alerts to show.</p>
                </div>

                <div style="margin-top:18px;">
                    <h3>üìä Quick Actions</h3>
                    <button onclick="acknowledgeAll()">Acknowledge All New</button>
                    <button onclick="downloadCSV()">Download CSV</button>
                </div>
            </div>

            <!-- Side panel briefly showing counts -->
            <div class="status-dashboard" style="min-width:300px; margin-left:20px;">
                <h2>üìä Live Transport Status</h2>
                <div class="stats-grid" style="margin-top:10px;">
                    <div class="stat-card">
                        <div class="stat-value" id="totalAlerts">0</div>
                        <div class="stat-label">Total SOS Alerts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="newAlerts">0</div>
                        <div class="stat-label">New</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="ackAlerts">0</div>
                        <div class="stat-label">Acknowledged</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Floating Emergency Widget (keeps behavior consistent with original site) -->
    <div class="floating-widget" onclick="emergencyHelp()">
        üÜò Emergency Help
    </div>

    <script>
        // Local emergency alerts storage (would be backed by server/db in production)
        const emergencyAlerts = [];

        // Helper to format timestamps
        function fmtTS(ts) {
            const d = new Date(ts);
            return d.toLocaleString('en-IN', { hour12: true });
        }

        // Render table rows
        function renderAlerts() {
            const tbody = document.querySelector('#emergencyTable tbody');
            const filterLoc = document.getElementById('filterLocation').value;
            const filterStatus = document.getElementById('filterStatus').value;
            tbody.innerHTML = '';
            const filtered = emergencyAlerts.filter(a => {
                if (filterLoc && a.location !== filterLoc) return false;
                if (filterStatus && a.status !== filterStatus) return false;
                return true;
            });

            if (filtered.length === 0) {
                document.getElementById('noAlertsMsg').style.display = 'block';
            } else {
                document.getElementById('noAlertsMsg').style.display = 'none';
            }

            filtered.sort((x,y) => y.timestamp - x.timestamp);

            filtered.forEach((a, idx) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><div style="font-weight:700">${fmtTS(a.timestamp)}</div><div class="small-muted">${new Date(a.timestamp).toISOString()}</div></td>
                    <td>${a.studentName}</td>
                    <td>${a.studentPhone}</td>
                    <td>${a.driverName || '‚Äî'}</td>
                    <td>${a.driverPhone || '‚Äî'}</td>
                    <td>${a.emergencyContact}</td>
                    <td>${a.location}</td>
                    <td>
                        <div style="display:flex; gap:6px; align-items:center;">
                            <span class="${a.status === 'new' ? 'tag-urgent' : 'small-muted'}">${a.status.toUpperCase()}</span>
                            <button style="padding:6px 8px; border-radius:6px; border:none; cursor:pointer;" onclick="ack(${a.id})">Acknowledge</button>
                        </div>
                    </td>
                `;
                tr.onclick = () => showAlertDetails(a);
                tbody.appendChild(tr);
            });

            // update counts
            document.getElementById('totalAlerts').textContent = emergencyAlerts.length;
            document.getElementById('newAlerts').textContent = emergencyAlerts.filter(x => x.status==='new').length;
            document.getElementById('ackAlerts').textContent = emergencyAlerts.filter(x => x.status==='ack').length;
        }

        // Small modal-like detail (simple)
        function showAlertDetails(a) {
            alert(
                'Emergency Alert Details:\\n' +
                'Time: ' + fmtTS(a.timestamp) + '\\n' +
                'Student: ' + a.studentName + ' (' + a.studentPhone + ')\\n' +
                'Driver: ' + (a.driverName || '‚Äî') + ' (' + (a.driverPhone || '‚Äî') + ')\\n' +
                'Emergency Contact: ' + a.emergencyContact + '\\n' +
                'Location: ' + a.location
            );
        }

        // API-like function to add an SOS alert (admin/driver/student/client would call this)
        function addSOSAlert({ studentName, studentPhone, driverName, driverPhone, emergencyContact, location, timestamp }) {
            const id = Math.floor(Math.random()*1000000);
            emergencyAlerts.push({
                id,
                studentName,
                studentPhone,
                driverName,
                driverPhone,
                emergencyContact,
                location,
                timestamp: timestamp || Date.now(),
                status: 'new'
            });
            renderAlerts();
        }

        // acknowledge a single alert
        function ack(id) {
            const a = emergencyAlerts.find(x => x.id === id);
            if (!a) return;
            if (a.status === 'new') a.status = 'ack';
            else if (a.status === 'ack') a.status = 'resolved';
            renderAlerts();
        }

        function acknowledgeAll() {
            emergencyAlerts.forEach(x => { if (x.status === 'new') x.status = 'ack' });
            renderAlerts();
        }

        function clearFilters() {
            document.getElementById('filterLocation').value = '';
            document.getElementById('filterStatus').value = '';
            renderAlerts();
        }

        function downloadCSV() {
            if (emergencyAlerts.length === 0) { alert('No alerts to download'); return; }
            const rows = [
                ['timestamp_iso','timestamp_local','student_name','student_phone','driver_name','driver_phone','emergency_contact','location','status']
            ];
            emergencyAlerts.forEach(a => {
                rows.push([
                    new Date(a.timestamp).toISOString(),
                    fmtTS(a.timestamp),
                    a.studentName,
                    a.studentPhone,
                    a.driverName || '',
                    a.driverPhone || '',
                    a.emergencyContact,
                    a.location,
                    a.status
                ]);
            });
            const csv = rows.map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'emergency_alerts.csv';
            document.body.appendChild(a);
            a.click();
            a.remove();
            URL.revokeObjectURL(url);
        }

        // simulate a few alerts for demo/admin testing
        function simulateSOS() {
            const samples = [
                { studentName:'Asha Reddy', studentPhone:'+91 90000 11111', driverName:'Ravi Kumar', driverPhone:'+91 9876543210', emergencyContact:'+91 94444 11111', location:'MBU Main Gate' },
                { studentName:'Karan Patel', studentPhone:'+91 90000 22222', driverName:'Mohan Das', driverPhone:'+91 9876543212', emergencyContact:'+91 98888 22222', location:'Library Block' },
                { studentName:'Neha Sharma', studentPhone:'+91 90000 33333', driverName:'Venkat Rao', driverPhone:'+91 9876543213', emergencyContact:'+91 97777 33333', location:'MBU Hostels' }
            ];
            samples.forEach(s => addSOSAlert({ ...s, timestamp: Date.now() - Math.floor(Math.random()*600000) }));
            renderAlerts();
        }

        // Keep emergencyHelp consistent: show a small alert and‚Äîif desired‚Äîopen admin view
        function emergencyHelp() {
            showSmallTopToast('üÜò Emergency services contacted. Help is on the way!');
            // optionally switch to admin mode to show alerts
            // switchMode('admin');
        }

        // small top toast (non-blocking)
        function showSmallTopToast(msg) {
            const el = document.createElement('div');
            el.textContent = msg;
            el.style.position = 'fixed';
            el.style.left = '50%';
            el.style.top = '12px';
            el.style.transform = 'translateX(-50%)';
            el.style.background = 'white';
            el.style.padding = '10px 16px';
            el.style.borderRadius = '10px';
            el.style.boxShadow = '0 8px 20px rgba(0,0,0,0.12)';
            document.body.appendChild(el);
            setTimeout(()=> el.remove(), 3500);
        }

        // small compatibility: mimic the project's switchMode (if present elsewhere)
        function switchMode(mode) {
            document.querySelectorAll('.mode-btn').forEach(b=>b.classList.remove('active'));
            document.querySelector('.mode-btn[onclick*="' + mode + '"]').classList.add('active');
            // hide other panels if they exist on the page
            ['studentPanel','driverPanel','adminPanel'].forEach(id=>{
                const el = document.getElementById(id);
                if (el) el.style.display = (id === 'adminPanel' && mode === 'admin') || (id === 'studentPanel' && mode === 'student') || (id === 'driverPanel' && mode === 'driver') ? 'block' : 'none';
            });
        }

        // initialize with a few sample alerts for demonstration
        document.addEventListener('DOMContentLoaded', () => {
            simulateSOS();
        });

    </script>
</body>
</html>
