<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MBU Smart Transport - Voice Chatbot</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #dbeafe 0%, #e0e7ff 100%);
            min-height: 100vh;
            color: #333;
        }

        .chatbot-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 400px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        /* Header */
        .chat-header {
            background: linear-gradient(135deg, #2563eb 0%, #6366f1 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }

        .chat-header h1 {
            font-size: 1.25rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        /* Voice Controls */
        .voice-controls {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            margin-top: 10px;
        }

        .stop-speaking-btn {
            background: #dc2626;
            padding: 8px;
            border-radius: 50%;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
            display: none;
        }

        .stop-speaking-btn:hover {
            background: #b91c1c;
        }

        /* Live Stats Bar */
        .live-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 12px;
            font-size: 0.75rem;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 8px;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            background: #f8fafc;
            max-height: calc(100vh - 300px);
        }

        .message {
            margin-bottom: 16px;
            display: flex;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message.bot {
            justify-content: flex-start;
        }

        .message-content {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 0.875rem;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #2563eb;
            color: white;
        }

        .message.bot .message-content {
            background: white;
            color: #374151;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-time {
            font-size: 0.625rem;
            opacity: 0.7;
            margin-top: 4px;
        }

        /* Quick Action Buttons */
        .quick-actions {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quick-btn {
            width: 100%;
            text-align: left;
            padding: 8px 12px;
            font-size: 0.75rem;
            background: #dbeafe;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:hover {
            background: #93c5fd;
        }

        /* Voice Recognition Indicator */
        .listening-indicator {
            display: none;
            justify-content: center;
            margin: 16px 0;
        }

        .listening-badge {
            background: #dc2626;
            color: white;
            padding: 8px 16px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.875rem;
            animation: pulse 1s infinite;
        }

        /* Input Area */
        .chat-input {
            padding: 20px;
            border-top: 1px solid #e5e7eb;
            background: white;
        }

        .input-row {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 12px;
        }

        .chat-text-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 25px;
            outline: none;
            font-size: 0.875rem;
            transition: border-color 0.3s;
        }

        .chat-text-input:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .voice-btn, .send-btn {
            width: 45px;
            height: 45px;
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: all 0.3s;
        }

        .voice-btn {
            background: #16a34a;
        }

        .voice-btn:hover {
            background: #15803d;
            transform: scale(1.1);
        }

        .voice-btn.listening {
            background: #dc2626;
            animation: pulse 1s infinite;
        }

        .send-btn {
            background: #2563eb;
            font-size: 16px;
        }

        .send-btn:hover {
            background: #1d4ed8;
            transform: scale(1.1);
        }

        /* Quick Shortcuts */
        .quick-shortcuts {
            display: flex;
            justify-content: center;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }

        .shortcut-btn {
            padding: 6px 12px;
            background: #f8fafc;
            border: 1px solid #e5e7eb;
            border-radius: 15px;
            font-size: 0.6875rem;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shortcut-btn:hover {
            background: #e2e8f0;
            transform: translateY(-1px);
        }

        /* Voice Status */
        .voice-status {
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Icons - Using Unicode symbols */
        .icon-car::before { content: "üöó"; }
        .icon-users::before { content: "üë•"; }
        .icon-clock::before { content: "‚è∞"; }
        .icon-sun::before { content: "‚òÄ"; }
        .icon-moon::before { content: "üåô"; }
        .icon-mic::before { content: "üé§"; }
        .icon-mic-off::before { content: "üé§"; }
        .icon-volume::before { content: "üîä"; }
        .icon-send::before { content: "‚û§"; }
    </style>
</head>
<body>
    <div class="chatbot-container">
        <!-- Header -->
        <div class="chat-header">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <span class="icon-car" style="font-size: 2rem;"></span>
                    <div>
                        <h1>MBU Smart Transport</h1>
                        <p>Voice & Text enabled</p>
                    </div>
                </div>
                
                <!-- Voice Controls -->
                <div class="voice-controls">
                    <button class="stop-speaking-btn" id="stopSpeakingBtn" onclick="stopSpeaking()" title="Stop speaking">
                        <span class="icon-volume"></span>
                    </button>
                </div>
            </div>
            
            <!-- Live Stats Bar -->
            <div class="live-stats">
                <span class="stat-item">
                    <span class="icon-users"></span>
                    <span id="availableDrivers">12</span> Drivers
                </span>
                <span class="stat-item">
                    <span class="icon-clock"></span>
                    <span id="averageWaitTime">8 minutes</span>
                </span>
                <span class="stat-item">
                    <span id="demandIcon" class="icon-sun"></span>
                    <span id="demandLevel">Medium</span>
                </span>
                <span class="stat-item">
                    <span class="icon-mic"></span>
                    <span id="voiceStatus">Voice Ready</span>
                </span>
            </div>
        </div>

        <!-- Chat Messages -->
        <div class="chat-messages" id="chatMessages">
            <div class="message bot">
                <div class="message-content">
                    Welcome to MBU Smart Transport! üöó I help students and drivers coordinate rides efficiently. You can type or speak to me. How can I assist you today?
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="handleOptionClick('Book a Ride')">Book a Ride</button>
                        <button class="quick-btn" onclick="handleOptionClick('Register as Driver')">Register as Driver</button>
                        <button class="quick-btn" onclick="handleOptionClick('Check Fares')">Check Fares</button>
                        <button class="quick-btn" onclick="handleOptionClick('Live Status')">Live Status</button>
                    </div>
                    <div class="message-time" id="initialTime">Just now</div>
                </div>
            </div>
        </div>
        
        <!-- Voice Recognition Indicator -->
        <div class="listening-indicator" id="listeningIndicator">
            <div class="listening-badge">
                <span class="icon-mic"></span>
                <span>Listening... Speak now</span>
            </div>
        </div>

        <!-- Input Area -->
        <div class="chat-input">
            <div class="input-row">
                <input type="text" class="chat-text-input" id="chatInput" placeholder="Type or speak your message..." onkeypress="handleEnter(event)">
                <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="Start voice input">
                    <span class="icon-mic"></span>
                </button>
                <button class="send-btn" onclick="sendMessage()">
                    <span class="icon-send"></span>
                </button>
            </div>
            
            <div class="quick-shortcuts">
                <button class="shortcut-btn" onclick="sendQuickMessage('Book ride to railway station')">üöÇ Railway</button>
                <button class="shortcut-btn" onclick="sendQuickMessage('Check fare to Tirupati')">üí∞ Fares</button>
                <button class="shortcut-btn" onclick="sendQuickMessage('How many autos available')">üöó Available</button>
            </div>
            
            <!-- Voice Status -->
            <div class="voice-status">
                <span id="voiceStatusText">üé§ Voice enabled - Click mic or say commands</span>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let recognition;
        let speechSynthesis = window.speechSynthesis;
        let isListening = false;
        let voiceEnabled = false;
        let isSpeaking = false;
        let currentFlow = '';
        let userType = '';
        let rideData = {};

        // Mock data
        const destinations = [
            { name: 'Tirupati Railway Station', distance: '12 km', baseFare: 150 },
            { name: 'Tirupati Bus Station', distance: '10 km', baseFare: 120 },
            { name: 'Chandana Brothers Mall', distance: '8 km', baseFare: 100 },
            { name: 'TTD Temple', distance: '15 km', baseFare: 180 },
            { name: 'Srikalahasti', distance: '25 km', baseFare: 300 },
            { name: 'Renigunta Airport', distance: '20 km', baseFare: 250 }
        ];

        const liveData = {
            availableDrivers: 12,
            pendingRequests: 8,
            peakHours: false,
            demandLevel: 'Medium',
            averageWaitTime: '8 minutes'
        };

        // Initialize Voice Recognition
        function initializeVoiceRecognition() {
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = false;
                recognition.lang = 'en-US';
                
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                    document.getElementById('listeningIndicator').style.display = 'flex';
                };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    document.getElementById('chatInput').value = transcript;
                    sendMessage();
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    stopListening();
                    addBotMessage("Sorry, I couldn't hear you clearly. Please try again or type your message.");
                };
                
                recognition.onend = () => {
                    stopListening();
                };
                
                voiceEnabled = true;
                updateVoiceStatus();
            } else {
                document.getElementById('voiceStatusText').textContent = 'üîá Voice not supported in this browser';
            }
        }

        // Voice Control Functions
        function toggleVoice() {
            if (isListening) {
                stopListening();
            } else {
                startListening();
            }
        }

        function startListening() {
            if (recognition && !isListening) {
                try {
                    recognition.start();
                } catch (error) {
                    console.error('Error starting recognition:', error);
                    addBotMessage("Voice recognition is not available. Please type your message.");
                }
            }
        }

        function stopListening() {
            if (recognition && isListening) {
                recognition.stop();
            }
            isListening = false;
            document.getElementById('voiceBtn').classList.remove('listening');
            document.getElementById('listeningIndicator').style.display = 'none';
        }

        function updateVoiceStatus() {
            const status = voiceEnabled ? 'Voice Ready' : 'Voice Off';
            document.getElementById('voiceStatus').textContent = status;
        }

        function speakText(text) {
            if (speechSynthesis && voiceEnabled) {
                speechSynthesis.cancel();
                
                const cleanText = text
                    .replace(/üöó|üéâ|üìç|‚è∞|üí∞|üöó|üìã|üí∞|üìä|üî¥|üü¢|üìÖ|ü§ñ|üì±|üí¨/g, '')
                    .replace(/‚Çπ/g, 'rupees ')
                    .replace(/\n+/g, '. ');
                
                const utterance = new SpeechSynthesisUtterance(cleanText);
                utterance.rate = 0.9;
                utterance.pitch = 1;
                utterance.volume = 0.8;
                
                utterance.onstart = () => {
                    isSpeaking = true;
                    document.getElementById('stopSpeakingBtn').style.display = 'block';
                };
                
                utterance.onend = () => {
                    isSpeaking = false;
                    document.getElementById('stopSpeakingBtn').style.display = 'none';
                };
                
                utterance.onerror = () => {
                    isSpeaking = false;
                    document.getElementById('stopSpeakingBtn').style.display = 'none';
                };
                
                speechSynthesis.speak(utterance);
            }
        }

        function stopSpeaking() {
            if (speechSynthesis) {
                speechSynthesis.cancel();
                isSpeaking = false;
                document.getElementById('stopSpeakingBtn').style.display = 'none';
            }
        }

        // Message Functions
        function handleEnter(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        function sendMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            addUserMessage(message);
            input.value = '';
            
            setTimeout(() => {
                processMessage(message);
            }, 500);
        }

        function sendQuickMessage(message) {
            addUserMessage(message);
            setTimeout(() => {
                processMessage(message);
            }, 500);
        }

        function handleOptionClick(option) {
            sendQuickMessage(option);
        }

        function addUserMessage(text) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user';
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${text}
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function addBotMessage(text, quickActions = null) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot';
            
            let actionsHTML = '';
            if (quickActions) {
                actionsHTML = '<div class="quick-actions">';
                quickActions.forEach(action => {
                    actionsHTML += `<button class="quick-btn" onclick="handleOptionClick('${action}')">${action}</button>`;
                });
                actionsHTML += '</div>';
            }
            
            messageDiv.innerHTML = `
                <div class="message-content">
                    ${text}
                    ${actionsHTML}
                    <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
                </div>
            `;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Auto-speak bot messages
            setTimeout(() => {
                speakText(text);
            }, 300);
        }

        // Message Processing Logic
        function processMessage(message) {
            const lowerMessage = message.toLowerCase();
            
            if (currentFlow === 'booking') {
                handleBookingFlow(lowerMessage);
            } else if (currentFlow === 'driver-registration') {
                handleDriverFlow(lowerMessage);
            } else {
                // Main menu logic with voice-friendly responses
                if (lowerMessage.includes('book') || lowerMessage.includes('ride') || lowerMessage.includes('travel')) {
                    startBookingFlow();
                } else if (lowerMessage.includes('driver') || lowerMessage.includes('register') || lowerMessage.includes('join')) {
                    startDriverFlow();
                } else if (lowerMessage.includes('fare') || lowerMessage.includes('price') || lowerMessage.includes('cost')) {
                    showFares();
                } else if (lowerMessage.includes('status') || lowerMessage.includes('live') || lowerMessage.includes('available')) {
                    showLiveStatus();
                } else if (lowerMessage.includes('help') || lowerMessage.includes('what') || lowerMessage.includes('how')) {
                    addBotMessage("I can help you with: booking rides, driver registration, checking fares, or viewing live status. You can speak or type your request. What would you like to do?", 
                        ['Book a Ride', 'Register as Driver', 'Check Fares', 'Live Status']);
                } else {
                    addBotMessage("I understand you said: " + message + ". I can help you book rides, register as driver, check fares, or see live status. What would you like to do?", 
                        ['Book a Ride', 'Register as Driver', 'Check Fares', 'Live Status']);
                }
            }
        }

        function startBookingFlow() {
            currentFlow = 'booking';
            userType = 'student';
            addBotMessage("Great! I'll help you book a ride. Where would you like to go? You can say the destination name.");
            
            const destinationOptions = destinations.map(dest => 
                `${dest.name} (‚Çπ${dest.baseFare})`
            );
            
            setTimeout(() => {
                addBotMessage("Here are popular destinations. You can speak or click:", destinationOptions);
            }, 2000);
        }

        function handleBookingFlow(input) {
            if (!rideData.destination) {
                // Enhanced voice recognition for destinations
                const selectedDest = destinations.find(dest => {
                    const destWords = dest.name.toLowerCase().split(' ');
                    const inputWords = input.split(' ');
                    
                    // Check for partial matches
                    return destWords.some(word => inputWords.some(inputWord => 
                        inputWord.includes(word) || word.includes(inputWord)
                    )) || input.includes(dest.name.toLowerCase());
                });
                
                if (selectedDest) {
                    rideData.destination = selectedDest;
                    addBotMessage(`Perfect! You selected ${selectedDest.name}. When do you need the ride? You can say "now", "in 30 minutes", "in one hour", or "schedule for later".`,
                        ['Now', 'In 30 minutes', 'In 1 hour', 'Schedule for later']);
                } else {
                    addBotMessage(`I heard "${input}". I couldn't find that destination. Please choose from the list or speak the name clearly.`);
                }
            } else if (!rideData.timing) {
                if (input.includes('now') || input.includes('immediately') || input.includes('right now')) {
                    rideData.timing = 'immediate';
                    completeBooking('immediate');
                } else if (input.includes('30') || input.includes('thirty')) {
                    rideData.timing = '30min';
                    completeBooking('30min');
                } else if (input.includes('hour') || input.includes('1') || input.includes('one')) {
                    rideData.timing = '1hour';
                    completeBooking('1hour');
                } else {
                    addBotMessage("Please specify when you need the ride. Say 'now', 'in 30 minutes', 'in one hour', or 'schedule for later':",
                        ['Now', 'In 30 minutes', 'In 1 hour', 'Schedule for later']);
                }
            }
        }

        function completeBooking(timing) {
            const surge = liveData.peakHours ? 1.5 : 1;
            const finalFare = Math.round(rideData.destination.baseFare * surge);
            
            const confirmationMessage = `Booking confirmed! Your ride to ${rideData.destination.name} is scheduled for ${timing === 'immediate' ? 'now' : timing === '30min' ? 'in 30 minutes' : 'in 1 hour'}. The fare is ${finalFare} rupees ${surge > 1 ? 'with peak hour pricing' : ''}. Driver will be assigned shortly and you'll receive SMS updates.`;

            addBotMessage(`üéâ ${confirmationMessage}`, ['Track Ride', 'Book Another', 'Main Menu']);
            
            currentFlow = '';
            rideData = {};
        }

        function startDriverFlow() {
            currentFlow = 'driver-registration';
            userType = 'driver';
            addBotMessage("Welcome, Driver! Are you registering as a new driver or updating your status? You can speak your choice.",
                ['New Registration', 'Update Status', 'View Earnings']);
        }

        function handleDriverFlow(input) {
            if (input.includes('new') || input.includes('register') || input.includes('registration')) {
                addBotMessage("Driver Registration Process: First, please tell me your vehicle type. Say Auto, Car, or Bike.", ['Auto', 'Car', 'Bike']);
            } else if (input.includes('status') || input.includes('available') || input.includes('update')) {
                addBotMessage("Update your availability. Say 'available now', 'busy', 'offline', or 'on route':", 
                    ['Available Now', 'Busy', 'Offline', 'On Route to MBU']);
            } else if (input.includes('earnings') || input.includes('money') || input.includes('payment')) {
                addBotMessage("Your earnings summary: Today 650 rupees, This week 4,200 rupees, This month 18,500 rupees. Peak earnings are between 6 to 8 PM and weekends. Bonus available: Complete 5 rides for 100 rupees extra!",
                    ['View Detailed Report', 'Peak Hours Alert', 'Main Menu']);
            }
        }

        function showFares() {
            let fareText = "Here's our transparent fare structure: ";
            destinations.forEach((dest, index) => {
                fareText += `${dest.name}: Base fare ${dest.baseFare} rupees, Peak hours ${Math.round(dest.baseFare * 1.5)} rupees. `;
            });
            
            fareText += "Dynamic pricing: Normal hours use base fare. Peak hours from 7 to 9 AM and 5 to 8 PM are 1.5 times. Festival and holiday rates are 2 times. Night rates from 10 PM to 6 AM are 1.3 times. Shared rides get 30% discount per person.";
            
            addBotMessage(fareText, ['Book a Ride', 'Shared Ride', 'Main Menu']);
        }

        function showLiveStatus() {
            const statusMessage = `Live transportation status: ${liveData.availableDrivers} drivers available, ${liveData.pendingRequests} pending requests, demand level is ${liveData.demandLevel}, average wait time is ${liveData.averageWaitTime}. ${liveData.peakHours ? 'Peak hours are active with higher demand' : 'Traffic is normal'}. Festival alert: Diwali is approaching, expect high demand from October 31st to November 2nd.`;
            
            addBotMessage(statusMessage, ['Book Now', 'Set Alert', 'Driver Mode']);
        }

        // Initialize on page load
        window.addEventListener('load', function() {
            initializeVoiceRecognition();
            
            // Set initial timestamp
            document.getElementById('initialTime').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        });
    </script>
</body>
</html>